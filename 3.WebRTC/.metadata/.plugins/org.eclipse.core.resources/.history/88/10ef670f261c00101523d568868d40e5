<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>SIP ì „í™”ê±¸ê¸°</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
	<script src="https://cdn.jsdelivr.net/npm/sip.js@0.20.0/dist/sip.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sip.js-simple@0.20.0/dist/sip.simple.min.js"></script>
	<script>
		let simpleUser;
		$(document).ready(function () {
			async function createSimpleUser(targetExtension) {
				const target = `sip:${targetExtension}@192.168.1.96`;

				const simple = new SIP.SimpleUser("ws://192.168.1.96:8088/ws", {
					userAgentOptions: {
						uri: 'sip:8887@192.168.1.96',
						authorizationUsername: "8887",
						authorizationPassword: "88871!"
					},
					media: {
						constraints: {audio: true, video: false},
					}
				});
				try {
					const callResponse = await simple.invite(target);
					console.log("Call initiated successfully", callResponse);
				} catch (error) {
					console.error("Error making call", error);
				}


				simple.delegate = {
					onCallAnswered: () => {
						$('#callStatus').text('âœ… í†µí™” ì—°ê²°ë¨');
					},
					onCallHangup: () => {
						$('#callStatus').text('ğŸ“´ í†µí™” ì¢…ë£Œë¨');
					},
					onCallReceived: () => {
						simple.answer();
					},
					onCallCreated: () => {
						$('#callStatus').text(`ğŸ“ ${targetExtension}ë¡œ ì „í™” ê±°ëŠ” ì¤‘...`);
					},
					onCallFailed: () => {
						$('#callStatus').text('âŒ í†µí™” ì‹¤íŒ¨');
					}
				};

				await simple.connect();
				return {simple, target};
			}

			async function makeCall() {

				const extension = $('#extensionInput').val().trim();
				if (!extension) {
					$('#callStatus').text('âŒ ë‚´ì„  ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
					return;
				}

				try {
					await navigator.mediaDevices.getUserMedia({audio: true});

					$('#callStatus').text('ğŸ” ë‚´ì„  ë²ˆí˜¸ í™•ì¸ ì¤‘...');

					$.get("/sip/list", async function (data) {
						const account = data.find(acc => acc.extension === extension);
						if (!account) {
							$('#callStatus').text('âŒ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë‚´ì„  ë²ˆí˜¸ì…ë‹ˆë‹¤.');
							return;
						}

						const {simple, target} = await createSimpleUser(extension);
						simpleUser = simple;

						await simpleUser.call(target);
					}).fail(() => {
						$('#callStatus').text('âŒ ì„œë²„ ì‘ë‹µ ì‹¤íŒ¨');
					});
				} catch (err) {
					console.error(err);
					$('#callStatus').text('âŒ ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
				}
			}
		});
	</script>
	<style>
		body {
			background-color: #f7f9fc;
		}

		.container {
			max-width: 500px;
			margin-top: 100px;
		}

		.status-box {
			height: 40px;
			font-weight: bold;
		}
	</style>
</head>

<body>
	<div class="container border rounded p-4 shadow bg-white">
		<h3 class="text-center mb-4">ğŸ“ ë‚´ì„  ë²ˆí˜¸ ì „í™”ê±¸ê¸°</h3>

		<div class="mb-3">
			<label for="extensionInput" class="form-label">ë‚´ì„  ë²ˆí˜¸ ì…ë ¥</label>
			<input type="text" class="form-control" id="extensionInput" placeholder="ì˜ˆ: 8888">
		</div>

		<div class="d-grid mb-3">
			<button class="btn btn-primary" onclick="makeCall()">ì „í™” ê±¸ê¸°</button>
		</div>

		<div id="callStatus" class="alert alert-secondary text-center status-box" role="alert">
			ëŒ€ê¸° ì¤‘...
		</div>
	</div>


</body>

</html>