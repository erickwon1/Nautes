<script src="https://cdn.jsdelivr.net/npm/sip.js-simple@0.20.0/dist/sip.simple.min.js"></script>
<script>
	let simpleUser;

	async function makeCall() {
		const extension = $('#extensionInput').val().trim();
		if (!extension) {
			$('#callStatus').text('âŒ ë‚´ì„  ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
			return;
		}

		try {
			await navigator.mediaDevices.getUserMedia({audio: true});

			$('#callStatus').text('ğŸ” ë‚´ì„  ë²ˆí˜¸ í™•ì¸ ì¤‘...');

			$.get("/sip/list", async function (data) {
				const account = data.find(acc => acc.extension === extension);
				if (!account) {
					$('#callStatus').text('âŒ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë‚´ì„  ë²ˆí˜¸ì…ë‹ˆë‹¤.');
					return;
				}

				const target = `sip:${extension}@192.168.1.96`;

				// SIP.SimpleUserë¡œ ë³€ê²½
				simpleUser = new SIP.SimpleUser("ws://192.168.1.96:8088/ws", {
					aor: "sip:8887@192.168.1.96",
					userAgentOptions: {
						authorizationUsername: "8887",
						authorizationPassword: "88871!"
					},
					media: {
						constraints: {audio: true, video: false}
					}
				});

				simpleUser.delegate = {
					onCallAnswered: () => $('#callStatus').text('âœ… í†µí™” ì—°ê²°ë¨'),
					onCallHangup: () => $('#callStatus').text('ğŸ“´ í†µí™” ì¢…ë£Œë¨'),
					onCallCreated: () => $('#callStatus').text(`ğŸ“ ${extension}ë¡œ ì „í™” ê±°ëŠ” ì¤‘...`),
					onCallFailed: () => $('#callStatus').text('âŒ í†µí™” ì‹¤íŒ¨')
				};

				await simpleUser.connect();
				await simpleUser.call(target);

			}).fail(() => {
				$('#callStatus').text('âŒ ì„œë²„ ì‘ë‹µ ì‹¤íŒ¨');
			});

		} catch (err) {
			console.error(err);
			$('#callStatus').text('âŒ ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
		}
	}
</script>