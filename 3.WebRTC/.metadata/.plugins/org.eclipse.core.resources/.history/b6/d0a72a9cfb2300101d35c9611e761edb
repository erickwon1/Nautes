<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>SIP ì „í™”ê±¸ê¸°</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
	<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sip.js@0.15.0/dist/sip.js"></script>
	<script>
		let userAgent;

		function createUserAgent() {
			userAgent = new SIP.UA({
				uri: 'sip:8887@192.168.1.96',  // SIP ì„œë²„ì™€ ê³„ì • URI
				transportOptions: {
					wsServers: ['ws://192.168.1.96:5066/ws'], // WebSocket ì„œë²„ ì£¼ì†Œ
					traceSip: true // SIP ë©”ì‹œì§€ ì¶”ì 
				},
				authorizationUser: '8887', // ì‚¬ìš©ì ì¸ì¦ ì •ë³´
				password: '88871!', // ë¹„ë°€ë²ˆí˜¸
				sessionDescriptionHandlerFactoryOptions: {
					constraints: {
						audio: true, // ì˜¤ë””ì˜¤ ì‚¬ìš©
						video: false // ì˜ìƒ ì‚¬ìš© ì•ˆ í•¨
					},
					peerConnectionOptions: {
						rtcConfiguration: {
							iceServers: []
						}
					},
					modifiers: [
						function removeUnsupportedCodecs(description) {
							const codecsToRemove = ['111', '63', '126', '110', '13', '8', '0']; // Opus, Red, Telephone-event

							// m=audio ì¤„ ìˆ˜ì • (ì½”ë± ë²ˆí˜¸ë§Œ ì œê±°)
							description.sdp = description.sdp.replace(/^m=audio .*$/gm, (line) => {
								// ì½”ë±ì„ ì œê±°í•œ í›„ lineì„ ë¦¬í„´
								return line
									.split(' ')
									.filter((part) => !codecsToRemove.includes(part)) // 111, 63, 126 ì œê±°
									.join(' ') + '\r'; // ìˆ˜ì •ëœ ë¼ì¸ ë°˜í™˜
							});

							// rtpmap / fmtp ì‚­ì œ
							description.sdp = description.sdp
								.split('\r\n')
								.filter((line) => {
									return !codecsToRemove.some((pt) => line.includes(`a=rtpmap:${pt}`) || line.includes(`a=fmtp:${pt}`));
								})
								.join('\r\n');

							// ìµœì¢… ìˆ˜ì •ëœ SDPë¥¼ ë¡œê·¸ë¡œ ì¶œë ¥í•˜ì—¬ í™•ì¸
							console.log("Modified SDP:", description.sdp);

							return Promise.resolve(description);
						}
					]

				}
			});

			userAgent.on('registered', () => {
				console.log("âœ… REGISTER ì„±ê³µ");
			});

			userAgent.on('registrationFailed', (err) => {
				console.error("âŒ REGISTER ì‹¤íŒ¨", err);
			});

		}

		async function makeCall() {
			const extension = $('#extensionInput').val().trim();
			if (!extension) {
				$('#callStatus').text('âŒ ë‚´ì„  ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
				return;
			}

			try {
				await navigator.mediaDevices.getUserMedia({audio: true}); // ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­

				$('#callStatus').text('ğŸ“ ì „í™” ì¤€ë¹„ ì¤‘...');

				if (!userAgent) {
					createUserAgent(); // User Agentê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ìƒì„±
				}

				const targetURI = `sip:${extension}@192.168.1.96`; // ì „í™” ê±¸ ëŒ€ìƒ
				const session = userAgent.invite(targetURI, {
					media: {
						constraints: {audio: true, video: false}
					}
				});

				// ì½œë°± ì²˜ë¦¬ (ì „í™” ìƒíƒœì— ë”°ë¥¸ UI ì—…ë°ì´íŠ¸)
				session.on('accepted', () => {
					$('#callStatus').text('âœ… í†µí™” ì—°ê²°ë¨');
				});

				session.on('bye', () => {
					$('#callStatus').text('ğŸ“´ í†µí™” ì¢…ë£Œë¨');
				});

				session.on('failed', () => {
					$('#callStatus').text('âŒ ì „í™” ì‹¤íŒ¨');
				});

				session.on('started', () => {
					$('#callStatus').text(`ğŸ“ ${extension}ë¡œ ì „í™” ê±°ëŠ” ì¤‘...`);
				});

			} catch (err) {
				console.error(err);
				$('#callStatus').text('âŒ ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
			}
		}
	</script>
</head>

<body>
	<div class="container border rounded p-4 shadow bg-white">
		<h3 class="text-center mb-4">ğŸ“ ë‚´ì„  ë²ˆí˜¸ ì „í™”ê±¸ê¸°</h3>

		<div class="mb-3">
			<label for="extensionInput" class="form-label">ë‚´ì„  ë²ˆí˜¸ ì…ë ¥</label>
			<input type="text" class="form-control" id="extensionInput" placeholder="ì˜ˆ: 8888">
		</div>

		<div class="d-grid mb-3">
			<button class="btn btn-primary" onclick="makeCall()">ì „í™” ê±¸ê¸°</button>
		</div>

		<div id="callStatus" class="alert alert-secondary text-center status-box" role="alert">
			ëŒ€ê¸° ì¤‘...
		</div>
	</div>
</body>

</html>