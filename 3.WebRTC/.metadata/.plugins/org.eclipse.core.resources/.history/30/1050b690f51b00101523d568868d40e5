<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>WebRTC ìŒì„± í†µí™”</title>
	<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 h-screen flex items-center justify-center">
	<div class="w-full max-w-md p-6 bg-white rounded-2xl shadow-xl flex flex-col items-center space-y-4">

		<h2 class="text-2xl font-bold">ğŸ™ï¸ ìŒì„± í†µí™”</h2>

		<!-- ìƒíƒœ í‘œì‹œ -->
		<div id="status" class="text-sm text-gray-600">ìƒíƒœ: ì—°ê²° ëŒ€ê¸° ì¤‘...</div>

		<!-- ë²„íŠ¼ ì˜ì—­ -->
		<div class="flex flex-col space-y-3 w-full">
			<button id="startBtn" class="w-full bg-green-500 hover:bg-green-600 text-white py-2 rounded-xl">Mic
				ON</button>
			<button id="toggleMic" class="w-full bg-gray-200 hover:bg-gray-300 py-2 rounded-xl">Mic OFF</button>
			<button id="callBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-xl">Call</button>
			<button id="hangupBtn" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 rounded-xl">Hang
				Up</button>
		</div>

		<!-- ì˜¤ë””ì˜¤ ìš”ì†Œ (ìˆ¨ê¸°ê¸°) -->
		<audio id="remoteAudio" autoplay class="hidden"></audio>
	</div>

	<script>
		let localStream;
		let peerConnection;
		let isMicMuted = false;

		const startBtn = document.getElementById('startBtn');
		const callBtn = document.getElementById('callBtn');
		const hangupBtn = document.getElementById('hangupBtn');
		const toggleMicBtn = document.getElementById('toggleMic');
		const remoteAudio = document.getElementById('remoteAudio');
		const status = document.getElementById('status');

		const signaling = new WebSocket('ws://192.168.2.121/signal');

		signaling.onmessage = async (message) => {
			const data = JSON.parse(message.data);

			if (data.offer) {
				await createPeerConnection();
				await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
				const answer = await peerConnection.createAnswer();
				await peerConnection.setLocalDescription(answer);
				signaling.send(JSON.stringify({answer}));
				status.textContent = 'ìƒíƒœ: ìƒëŒ€ë°©ì˜ ìš”ì²­ì— ì‘ë‹µí•¨';
			} else if (data.answer) {
				await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
				status.textContent = 'ìƒíƒœ: ì—°ê²° ì™„ë£Œ';
			} else if (data.candidate) {
				try {
					await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
				} catch (e) {
					console.error('ICE candidate ì¶”ê°€ ì˜¤ë¥˜', e);
				}
			}
		};

		async function createPeerConnection() {
			peerConnection = new RTCPeerConnection({
				iceServers: [
					{urls: 'stun:stun.l.google.com:19302'} // STUN ì„œë²„ ì„¤ì •
				]
			});

			peerConnection.onicecandidate = event => {
				if (event.candidate) {
					signaling.send(JSON.stringify({candidate: event.candidate}));
				}
			};

			peerConnection.ontrack = event => {
				remoteAudio.srcObject = event.streams[0];
			};

			localStream.getTracks().forEach(track => {
				peerConnection.addTrack(track, localStream);
			});
		}

		startBtn.onclick = async () => {
			try {
				localStream = await navigator.mediaDevices.getUserMedia({audio: true});
				status.textContent = 'ìƒíƒœ: ë§ˆì´í¬ í™œì„±í™”ë¨';
			} catch (e) {
				console.error('ì˜¤ë””ì˜¤ ì ‘ê·¼ ì˜¤ë¥˜:', e);
				status.textContent = 'ìƒíƒœ: ë§ˆì´í¬ ì ‘ê·¼ ì‹¤íŒ¨';
			}
		};

		callBtn.onclick = async () => {
			await createPeerConnection();
			const offer = await peerConnection.createOffer();
			await peerConnection.setLocalDescription(offer);
			signaling.send(JSON.stringify({offer}));
			status.textContent = 'ìƒíƒœ: ì—°ê²° ìš”ì²­ ë³´ëƒ„';
		};

		hangupBtn.onclick = () => {
			if (peerConnection) {
				peerConnection.close();
				peerConnection = null;
			}
			status.textContent = 'ìƒíƒœ: í†µí™” ì¢…ë£Œë¨';
		};

		toggleMicBtn.onclick = () => {
			if (!localStream) return;
			const audioTrack = localStream.getAudioTracks()[0];
			isMicMuted = !isMicMuted;
			audioTrack.enabled = !isMicMuted;
			toggleMicBtn.textContent = isMicMuted ? 'ğŸ¤ ë§ˆì´í¬ ì¼œê¸°' : 'ğŸ¤ ë§ˆì´í¬ ë„ê¸°';
		};
	</script>
</body>

</html>